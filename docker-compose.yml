services:
  chess-game:
    build:
      context: . # 構建上下文為當前目錄
      dockerfile: Dockerfile # 使用當前目錄的 Dockerfile

    # 容器名稱
    container_name: chess-game

    # 端口映射 - 主機端口:容器端口
    ports:
      - "${PORT:-3000}:${NGINX_PORT:-3000}" # 如果沒有設置 PORT 環境變量，默認使用 3000

    # 環境變量
    environment:
      - NODE_ENV=${NODE_ENV}
      - NGINX_PORT=${NGINX_PORT}
      - NGINX_SERVER_NAME=${NGINX_SERVER_NAME}

    # 重啟策略
    restart: unless-stopped

    # 資源限制
    deploy:
      resources:
        limits:
          cpus: "0.5" # 限制最高 0.5 核 (Demo 靜態站點非常足夠)
          memory: 128M # 限制最高 128MB (Nginx Alpine 只需 ~10MB)
        reservations:
          cpus: "0.05" # 保留極少 CPU
          memory: 32M # 保留 32MB 即可啟動

    # 健康檢查
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "wget -q --spider http://127.0.0.1:${NGINX_PORT:-3000}/ || exit 1",
        ]
      interval: 1m # 每分鐘檢查一次
      timeout: 10s # 超時時間 10 秒
      retries: 3 # 重試 3 次
      start_period: 10s # 啟動後等待 30 秒開始檢查

    # 日誌配置
    logging:
      driver: "json-file"
      options:
        max-size: "10m" # 每個日誌文件最大 10MB
        max-file: "3" # 保留 3 個日誌文件
