<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="abc.scss">
</head>

<body>
    <div class="board-container">
        <div class="chess-board"></div>
    </div>
    <div class="container">
        <button class="reset">Reset Board</button>
        <div class="message">Sorry, invalid move!</div>
    </div>
</body>

</html>
<script src="">
    const Type = {
        white: 0,
        black: 1
    }
    const messageBox = document.getElementsByClassName('message')[0];
    const resetBtn = document.getElementsByClassName('reset')[0];
    const isValidMove = (source, dest, type) => {
        if (!source || !dest) return false;
        const regex = /(\d+)_(\d+)/;
        source = source.match(regex);
        dest = dest.match(regex);
        const y_delta = type == Type.black ? -1 : 1;
        const dest_Row = Number(dest[1]), dest_Col = Number(dest[2]), src_Row = Number(source[1]), src_Col = Number(source[2]);
        if (dest_Row == src_Row + y_delta) {
            if (dest_Col <= src_Col + 1 && dest_Col >= src_Col - 1) {
                return true;
            }
        }
        return false;
    };


    let turn = Type.black;
    let selectedPiece = null;
    let selectedBlock = null;

    class Piece {
        constructor(color, fn) {
            this.dom = document.createElement(color);
            this.dom.classList.add(color);
            this.dom.classList.add('piece');
            this.dom.setAttribute('data-type', Type[color]);
            this.dom.addEventListener('click', this.handleClick.bind(this));
            this.parentBlockSelect = fn;
            this.type = Type[color];
        }
        handleClick(e) {
            if (turn == Type[this.dom.classList[0]]) {
                let allPieces = document.getElementsByClassName('piece');
                Array.prototype.forEach.call(allPieces, function (el) {
                    el.classList.remove('selected');
                })
                this.dom.classList.add('selected');
                selectedPiece = this;
                this.parentBlockSelect();
                e.stopPropagation();
            }
        }
    }

    class Block {
        constructor(color, identifier) {
            this.dom = document.createElement('div');
            this.dom.classList.add(color);
            this.dom.classList.add('block');
            this.dom.setAttribute('data-id', identifier);
            this.dom.addEventListener('click', this.handleClick.bind(this));
        }
        addPiece(color) {
            const piece = new Piece(color, this.blockSelect.bind(this));
            this.dom.appendChild(piece.dom);
        }
        blockSelect() {
            selectedBlock = this;
        }
        handleClick() {
            if (!selectedBlock || !selectedPiece) return;
            if (isValidMove(selectedBlock.dom.getAttribute('data-id'), this.dom.getAttribute('data-id'), selectedPiece.type)) {
                if (this.dom.hasChildNodes()) {
                    // make a kill
                    this.dom.removeChild(this.dom.lastChild);
                }
                selectedBlock.dom.removeChild(selectedBlock.dom.lastChild);
                selectedPiece.dom.classList.remove('selected');
                this.dom.appendChild(selectedPiece.dom);
                selectedPiece.parentBlockSelect = this.blockSelect.bind(this);
                turn = (turn + 1) % 2;
                selectedBlock = null;
                selectedPiece = null;
                messageBox.classList.remove('show');
                messageBox.classList.add('hide');
            } else {
                // not a valid move
                messageBox.classList.remove('hide');
                messageBox.classList.add('show');
            }
        }
    }

    class Board {
        constructor(ele, size) {
            this.dom = ele;
            this.size = size;
        }
        init() {
            const boardEle = this.dom;
            while (boardEle.hasChildNodes()) {
                boardEle.removeChild(boardEle.lastChild);
            }
            const total_blocks = this.size * this.size;
            for (let b = 0; b < total_blocks; b++) {
                let row = parseInt(b / 8);
                let col = b % 8;
                let block_identifier = row + '_' + col;
                let block;
                if ((b + row) % 2 == 0) {
                    // apend white
                    block = new Block('white', block_identifier);
                } else {
                    // append black
                    block = new Block('black', block_identifier);
                }
                // add pieces
                if (b < 16) {
                    block.addPiece('white');
                } else if (b >= 48) {
                    block.addPiece('black');
                }
                boardEle.appendChild(block.dom);
                messageBox.classList.remove('show');
                messageBox.classList.add('hide');
            }
        }
    }

    const startGame = () => {
        const size = 8;
        const ele = document.getElementsByClassName('chess-board')[0];
        const board = new Board(ele, size);
        board.init();

        resetBtn.addEventListener('click', board.init.bind(board));

    }

    document.addEventListener('DOMContentLoaded', startGame);


</script>